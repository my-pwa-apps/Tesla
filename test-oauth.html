<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tesla OAuth Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #000;
            color: #fff;
        }
        .test-box {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        button {
            background: #3e6ae1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #2d59d0;
        }
        pre {
            background: #0a0a0a;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .error { color: #ef4444; }
        .success { color: #10b981; }
        .warning { color: #f59e0b; }
    </style>
</head>
<body>
    <h1>üîç Tesla OAuth Diagnostic Tool</h1>
    
    <div class="test-box">
        <h2>Current Configuration</h2>
        <pre id="config"></pre>
    </div>

    <div class="test-box">
        <h2>Test OAuth URL</h2>
        <p>Click to test if Tesla accepts the OAuth request:</p>
        <button onclick="testOAuth()">Test OAuth Flow</button>
        <button onclick="testDirectLink()">Open Direct Link</button>
        <div id="result"></div>
    </div>

    <div class="test-box">
        <h2>Backend Status</h2>
        <button onclick="testBackend()">Test Backend</button>
        <pre id="backend-result"></pre>
    </div>

    <div class="test-box">
        <h2>Recommendations</h2>
        <div id="recommendations">
            <p class="warning">‚ö†Ô∏è Tesla has recently changed their API access requirements:</p>
            <ul>
                <li><strong>Fleet API</strong>: New apps may need to use Fleet API instead of Owner API</li>
                <li><strong>Business Account</strong>: Third-party access might require a business account</li>
                <li><strong>App Approval</strong>: Your app may need Tesla's approval before use</li>
                <li><strong>Regional Restrictions</strong>: Some regions have limited API access</li>
            </ul>
            <p class="warning">Consider using <a href="https://tessie.com" target="_blank" style="color: #3e6ae1;">Tessie</a> ($5/month) which handles all Tesla API complexity.</p>
        </div>
    </div>

    <script>
        const CLIENT_ID = '98115f27-6ac6-4a11-9bc8-c256cce5f8cc';
        const REDIRECT_URI = window.location.origin + window.location.pathname.replace('test-oauth.html', 'Tesla/callback.html');
        const BACKEND_URL = 'https://tesla-gilt-delta.vercel.app/api';

        // Display config
        document.getElementById('config').textContent = JSON.stringify({
            clientId: CLIENT_ID,
            redirectUri: REDIRECT_URI,
            backendUrl: BACKEND_URL,
            origin: window.location.origin,
            pathname: window.location.pathname
        }, null, 2);

        async function testBackend() {
            const result = document.getElementById('backend-result');
            result.innerHTML = '<span class="warning">Testing...</span>';
            
            try {
                const response = await fetch(`${BACKEND_URL}/config`);
                const data = await response.json();
                result.innerHTML = `<span class="success">‚úÖ Backend is working!</span>\n${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Backend error: ${error.message}</span>`;
            }
        }

        function testOAuth() {
            const result = document.getElementById('result');
            result.innerHTML = '<p class="warning">Attempting OAuth flow...</p><p>Check browser console for details.</p>';
            
            const state = btoa(Math.random().toString()).substring(0, 32);
            const codeChallenge = 'test_challenge_' + Math.random().toString(36).substring(7);
            
            const authUrl = `https://auth.tesla.com/oauth2/v3/authorize?` + new URLSearchParams({
                client_id: CLIENT_ID,
                redirect_uri: REDIRECT_URI,
                response_type: 'code',
                scope: 'openid offline_access vehicle_device_data vehicle_cmds vehicle_charging_cmds',
                state: state,
                code_challenge: codeChallenge,
                code_challenge_method: 'S256'
            }).toString();
            
            console.log('OAuth URL:', authUrl);
            
            // Try to fetch to see the exact error
            fetch(authUrl, { method: 'HEAD', mode: 'no-cors' })
                .then(() => {
                    result.innerHTML = '<p class="warning">Redirecting to Tesla login...</p>';
                    window.location.href = authUrl;
                })
                .catch(err => {
                    result.innerHTML = `<p class="error">Error: ${err.message}</p>`;
                });
        }

        function testDirectLink() {
            const state = btoa(Math.random().toString()).substring(0, 32);
            const codeChallenge = 'test_challenge_' + Math.random().toString(36).substring(7);
            
            const authUrl = `https://auth.tesla.com/oauth2/v3/authorize?` + new URLSearchParams({
                client_id: CLIENT_ID,
                redirect_uri: REDIRECT_URI,
                response_type: 'code',
                scope: 'openid offline_access vehicle_device_data vehicle_cmds vehicle_charging_cmds',
                state: state,
                code_challenge: codeChallenge,
                code_challenge_method: 'S256'
            }).toString();
            
            window.open(authUrl, '_blank');
        }

        // Auto-test backend on load
        testBackend();
    </script>
</body>
</html>
